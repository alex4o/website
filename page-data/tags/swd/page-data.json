{"componentChunkName":"component---src-templates-tag-js","path":"/tags/swd/","result":{"data":{"site":{"siteMetadata":{"title":"Bonin's website"}},"allMarkdownRemark":{"nodes":[{"id":"0f5c7399-a480-58bf-9b24-02180d25399c","excerpt":"While struggling to find a good use for the blackpill boards I have, I found out that they can be used as debug probeс over JTAG and SWD. This is why I decided…","fields":{"slug":"/blackpill-jlink/"},"html":"<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b29622084c0a117686109d3462eb7a5/d2602/black_pill.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAWAQEBAQAAAAAAAAAAAAAAAAADAQL/2gAMAwEAAhADEAAAAdaQZq4mGv8A/8QAGRAAAgMBAAAAAAAAAAAAAAAAERIBAgMA/9oACAEBAAEFArZ0DZq8cTWc4VT3/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPwG5a//EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8BqGP/xAAaEAACAgMAAAAAAAAAAAAAAAAAARBBITGh/9oACAEBAAY/ArLMiXTbj//EABkQAQADAQEAAAAAAAAAAAAAAAEAITERUf/aAAgBAQABPyHjLnLmgJ9gMbCXihehnnarIaOz/9oADAMBAAIAAwAAABDHz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QD//EABYRAQEBAAAAAAAAAAAAAAAAAAARQf/aAAgBAgEBPxCmI//EABsQAQEAAwEBAQAAAAAAAAAAAAERACExQXGB/9oACAEBAAE/EAuoVjpmaNtIFsfN+4PwmkXDIBpFIGlh9mKFlBIBD5+YZTVNVe5//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Blackpill on a breadboard\"\n        title=\"The blackpill board that will be the subject of today&#39;s experimentation. It has an stm32f103 chip on board with 64kb of flash and 20kb of sram.\"\n        src=\"/static/3b29622084c0a117686109d3462eb7a5/1c72d/black_pill.jpg\"\n        srcset=\"/static/3b29622084c0a117686109d3462eb7a5/a80bd/black_pill.jpg 148w,\n/static/3b29622084c0a117686109d3462eb7a5/1c91a/black_pill.jpg 295w,\n/static/3b29622084c0a117686109d3462eb7a5/1c72d/black_pill.jpg 590w,\n/static/3b29622084c0a117686109d3462eb7a5/a8a14/black_pill.jpg 885w,\n/static/3b29622084c0a117686109d3462eb7a5/fbd2c/black_pill.jpg 1180w,\n/static/3b29622084c0a117686109d3462eb7a5/d2602/black_pill.jpg 4032w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">The blackpill board that will be the subject of today&#39;s experimentation. It has an stm32f103 chip on board with 64kb of flash and 20kb of sram.</figcaption>\n  </figure></p>\n<p>While struggling to find a good use for the blackpill boards I have, I found out that they can be used as debug probeс over JTAG and SWD. This is why I decided on designating one of the unused boards I don't use for that task. But first I had to decide on the software I will use. My main use case was to use it with <a href=\"http://openocd.org/\">OpenOCD</a>. There are a few good firmware that can be flashed to enable such functionality on the blackpill. Here is a non-exhaustive list:</p>\n<ul>\n<li><a href=\"https://github.com/blacksphere/blackmagic/wiki\">blackmagic probe</a></li>\n<li><a href=\"https://github.com/jeanthom/DirtyJTAG\">DirtyJTAG</a></li>\n<li><a href=\"https://github.com/majbthrd/DapperMime\">DapperMime</a></li>\n<li><a href=\"https://github.com/RadioOperator/STM32F103C8T6_CMSIS-DAP_SWO\">DMSIS-DAP_SWO</a></li>\n<li><a href=\"http://e.pavlin.si/2016/02/28/how-to-program-blank-stm32f1-with-stlink-v2-firmware/\">STLink-v2</a></li>\n<li><a href=\"https://github.com/zoobab/versaloon\">Versaloon</a></li>\n<li><a href=\"https://github.com/lamfe/versaloon-git\">Versaloon-git</a> a more recent version of versaloon</li>\n<li><a href=\"https://github.com/GCY/JLINK-ARM-OB\">JLINK-OB-STM32-F103</a></li>\n</ul>\n<p>I have used the blackmagic probe in the past and it is very convenient, but\nthe fact that it can only support the CPUs that it is compiled with is very\nrestricting. It also doesn't work with OpenOCD. For that reason I also tried using Versaloon, its code hasn't been updated for almost 5 years. and it was failing to scan for devices in OpenOCD, so I declared that it has most likely bit-rotted.</p>\n<p>I wanted a device that is supported by OpenOCD and works consistently. Having seen that there are cheap JLink clones online, I searched how this is done and is there a way I can replicate this. So I decided to go the illegal route and make a clone myself. This means that I will use the JLink firmware dumped from a probe to create my own diy debugger.</p>\n<h2 id=\"installation\">Installation</h2>\n<p>The first time I heard about a dump of the firmware was when I found the <a href=\"https://github.com/GCY/JLINK-ARM-OB\">JLINK-OB-STM32-F103</a> repository. This is an image that is intended for people who want to integrate a debugger on the same board as their main chip (This is why it is called OB or On Board). That piqued my interest in the topic again and I decided to flash it on one of the boards I have. I first flashed the <a href=\"https://github.com/GCY/JLINK-ARM-OB/blob/master/2012%20version/jlink%20firmware.hex\">firmware from 2012</a> and checked the output from <code class=\"language-text\">lsusb</code> to see this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Bus 001 Device 007: ID 1366:0101 SEGGER J-Link PLUS</code></pre></div>\n<p>Seeing that it got recognized by the OS properly made me hopeful enough to try download the <a href=\"https://aur.archlinux.org/packages/jlink/\">JLink Software</a>.\nWhich detected the device and to my amusement even offered to upgrade its firmware.</p>\n<table>\n<thead>\n<tr>\n<th>Upgrade dialog</th>\n<th>Upgrade progress</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 546px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/afd2ba1e5380cfc0bfcac264b2b32d21/76aed/firmware-upgrade-2012.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVQoz02Q709SYRzF738Rgjg22HKAW/431dvGLzPMF4JoP/6Utrb+hFoZisD1wgUSvPIbhERDU9PSaVkvPj3PY7henJ3zfHfuOWdXG7PbcTgcOCcmGB93Krjdbnw+H16vl3vT0/inptT77uQkfr8fj8fDHZsNm20Mu/hWaqfTicvlQnsyO0MkFCQcCtxwMMD80yjLS4skFmOCE8RjCzxfXiIRj/HyxTPm56IEA4+IhEM8joSZETwXneXhg/to15cXdFs12o1tGtUKnWaVmrVJU+jGdplKyaRuldWtVbOwNgvK87nb5OuXXX5dnHH54xu/r87J6etoViVOt9mj1xahdYud1g3LkpHutesibIt+pyG8Vfb6HY4P9jgaDlSoxNX5KZlUEm3Q/4iRyVDMZTGyKT4VcpRMQ7WZhrzrlPIblIt5CkaWgvDp6TWlpT+7vqp8siz54R3an5/XnB0POT0aCj7g+8nhrR5B3kb3k8N9Br02HfGL9nd31Eq5WLIM10qmLlp1inldrfkfco1sN+Wyf5A6vboi1rwllXwvQpKk11YwN9K8ef2Kv715pY2cAohUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Firmware update\"\n        title=\"Firmware update\"\n        src=\"/static/afd2ba1e5380cfc0bfcac264b2b32d21/76aed/firmware-upgrade-2012.png\"\n        srcset=\"/static/afd2ba1e5380cfc0bfcac264b2b32d21/12f09/firmware-upgrade-2012.png 148w,\n/static/afd2ba1e5380cfc0bfcac264b2b32d21/e4a3f/firmware-upgrade-2012.png 295w,\n/static/afd2ba1e5380cfc0bfcac264b2b32d21/76aed/firmware-upgrade-2012.png 546w\"\n        sizes=\"(max-width: 546px) 100vw, 546px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Firmware update</figcaption>\n  </figure></td>\n<td><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 532px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fe9c648c39919a496bb0cf673c232ed6/89a37/upgrade-fail-2012.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSElEQVQ4y42T+24SURDG9xlICtLQ2AdobMSmvJLGROMraKWtjdqLvoXx0hsFS9Gq0aZUaCkFyv2yLMsCC7tcvMR8zhygmtom/vHLzOzO+c7MOXMkm+0KHGNjcDgcsI+O4ur4OFwuF6anpzExMYFrk5O4MTUFp9OJ6wTHbPmf3W7HyIgVViths8FisUC6d/cOFuZn4Z65j9mHD8h349nyIlaWnmJ58YmA/SH8j3m+soRHc27MuWfEuscL87h96yakT7sB1FUZ5UIGcj4t/Gq5IPx0Iop8OoFcKo5C5lRYpphNipjhdTnK6ZkN7AbeQvJ51hAO7iEU/ILwwR72P39E9OgrIqEgIuEgjkL7yCRjQpwti5Ros2IuReIJ5ClmapUSPOtvIG1vbYjk2HEYWVpwenKE+PEhEmRVOQ+llINGyZpSFNUbjSqatYqgVVcFjaqCb+0muDjpw7tt9IwGfSxD15RBct8OY7ZDOO88XF2XNHyedRb0o9Oqi90vSj7PRaK8tmfq8G4OKhwK/l3JZVxWIWv4fR665fc7otz/EWwQw3Nj+DxNXRPH8qNrILDtheT3btCBF8SoaBehDCC/RheTG9z4kDhdZjIWEeO09uoFpNerazBbTbSNPh3jj8+YLR1ms9GHfE1VoCryGXKRJkGmCdBUbPEZera8aDV18YGpVSvUmgq9ronYIKGu2ULHbAp6HYMwz/jebaNNG+HXT2rZB2nHtynmL0IDHD08EPaEBptb4cHmVirFrHgR/5KmF5USratyDhurL/EbcDFyAa1C0LEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Waiting for connection ...\"\n        title=\"Waiting for connection ...\"\n        src=\"/static/fe9c648c39919a496bb0cf673c232ed6/89a37/upgrade-fail-2012.png\"\n        srcset=\"/static/fe9c648c39919a496bb0cf673c232ed6/12f09/upgrade-fail-2012.png 148w,\n/static/fe9c648c39919a496bb0cf673c232ed6/e4a3f/upgrade-fail-2012.png 295w,\n/static/fe9c648c39919a496bb0cf673c232ed6/89a37/upgrade-fail-2012.png 532w\"\n        sizes=\"(max-width: 532px) 100vw, 532px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Waiting for connection ...</figcaption>\n  </figure></td>\n</tr>\n</tbody>\n</table>\n<p>I didn't have very high expectations from this as I knew that the bootloader\non the blackpill wouldn't manage the upgrade. But I didn't consider the fact that it might just flash something that makes the probe inoperable. Which turned out to be the case. The <code class=\"language-text\">JLinkExe</code> showed a probe faulty message.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/763fb2203906ab3eb36986c3ed868796/ef3e1/probe-defective.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9UlEQVQoz3WR2W8SURTG7wP7DjVsCYQl4Y9QEzXRuiA79clojejfaaImVIZFoIFhCgPDNrS1tPLg4+c9l07SB3345Zx75n7fOXMuO3z2FKViAYV8bk8hh2IhK6iU8/hw/Ba1j+/w+dMxarX3qFYK/FteaIjirbZcKiL3OgvWaf7AcjZBv9PEsN/BoN9DW5LxszlCR1LQagzQbsjoNCkfQqoPMBmNsJgqnDNoqoI5j8vZGL22BPb1ywmUIV38BunkO9SzEebqGtpkidl4xQWcyS08X0x1rOcaR4W+mGKlqTyfYrPScNptgbUaddGB3OXTLlRlwI32aJN9nKtDfkfmZjKuzhe4vlxje6Fz1jzXeW2F3fYCyqAH1pbq+LPb4vfVOXYcunB9ucENZ5/rQvyvnLj5tRGTzsYyuu0GGC3SeBRa9pujqlgw5ZVyScSjakXU9g+RF7Xsq5fiEV48P8STx48EDx/cB/P7/bDbHXC6XLA7HPB4POJMda/XBwev2Ww2mM1mmC0WmEwmMMb+TyqVQjqdRjQaRTgcRjweRzKZRCwWQzAYRCQSQSAQgM/nE1BO3Ds4EE2tVqtoaMASiYQwzGQywoQuh0IhPp1XTGtAZmRAIguf1IAmNyLBSEzQhCSiX3S73XA6ncLUxVdBZ8P4rviumdHgLwIaykMOkZz4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"J-Link is defective\"\n        title=\"J-Link is defective\"\n        src=\"/static/763fb2203906ab3eb36986c3ed868796/fcda8/probe-defective.png\"\n        srcset=\"/static/763fb2203906ab3eb36986c3ed868796/12f09/probe-defective.png 148w,\n/static/763fb2203906ab3eb36986c3ed868796/e4a3f/probe-defective.png 295w,\n/static/763fb2203906ab3eb36986c3ed868796/fcda8/probe-defective.png 590w,\n/static/763fb2203906ab3eb36986c3ed868796/ef3e1/probe-defective.png 759w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">J-Link is defective</figcaption>\n  </figure></p>\n<p>As I had downloaded the whole repository I decided to flash the <a href=\"https://github.com/GCY/JLINK-ARM-OB/blob/master/J-Link%20OB-STM32F103%20V1%20compiled%20Jan%20%207%202019/JLink-OB%20STM32F103%20JLinkARM.dll%20v6.44f%20.bin\">version from  2019</a> and see what happens. It again reports itself to <code class=\"language-text\">lsusb</code> as a <code class=\"language-text\">J-LinkPLUS</code> and asked me to upgrade its firmware. The update failed again making the device inoperable in the process.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 541px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19512d1bee41c6aa7b7367735500b151/9d576/upgrade-fail-2019.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkUlEQVQ4y4WTTU9TQRSG7x9giQmwgB07FqWUjfwFdWn0XyifNqiJiYmJWxGoFUoLtQhaEAQpxkSjaLGUAm3pd2npN21vuS20FHydM5diTIgunrxn3pk5c+6ZO0J9/RW0tLSgubkZjY1NaG1txdWuLqhUKig7OqBUKqHq7JTHLFa0t0OhUKCtrQ0NDQ0XNDY1oa6uDsKgegATY1qMDj/Di5HnGNNqYJgYg0Eno9e9xKR+XPYYU3odjJMT3NOMDEGrGYZmeAhTBh1uXL8G4ZNlGanYHvbDfoT9uzxOxyPYC3j42Ofehn/XyecjQS9CzCM/k4giHgkhGvJxX8qn8WBQDWF5cZ5v2lhfk7GuYdP2A0Gvi2/cdTqYehD0uXkcIt1x8Pmg1w2PawsBjxMHyX30dt+BYFle5Au27OvY2fwJD9tks36D07EBL1vssFmRYhVTJXQwVUOJqMLa15CWiyIG+nogrH54j0I2xU9Is0WkmXMlcuk4xIMk5zCX4krrax6RTcVQPZZA9yF8XFlChWUnM59JXAol/RdUQKVUwKOH9+WE5f8kvAy5OrnSLEt6Vi5CPdAHYWlhjpu8H4kIO61GlPeHoLjmURvo8FiY3a7fhWjAjbDPiXw6hv7ebgjmGRMSkSAnfq5/Ef1DPBKAe9sO19YGduxW2K1fsb72GbbvX+BjF9jXcxeC3jiNavUEJekQRyWJUZS1KMfkFw8LF4j5HCPLtSDmuOayBzitVnCvn33yqmUFlSMJuUySQ/0Q2S1KYpb1KsnnUC3j18kxh2LOaZlJCUeSiEwyBpxV5B/76ZPHmH87w57UOIzs+RCv2NOaNhp4TC1ZMM/inXmGUVM5nnvzGqYpPca1ozDPmnD71k38BnfBXyg7mBg8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Firmware update failed\"\n        title=\"Firmware update failed\"\n        src=\"/static/19512d1bee41c6aa7b7367735500b151/9d576/upgrade-fail-2019.png\"\n        srcset=\"/static/19512d1bee41c6aa7b7367735500b151/12f09/upgrade-fail-2019.png 148w,\n/static/19512d1bee41c6aa7b7367735500b151/e4a3f/upgrade-fail-2019.png 295w,\n/static/19512d1bee41c6aa7b7367735500b151/9d576/upgrade-fail-2019.png 541w\"\n        sizes=\"(max-width: 541px) 100vw, 541px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Firmware update failed</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Connecting to J-Link via USB...FAILED: Cannot connect to J-Link.</code></pre></div>\n<p>From this, I could infer that this device is still supported as the newest update for it is from 2021, but I didn't know where and how I could even obtain the firmware, maybe I could dump it while it is downloaded from the internet or something similar. For now, I decided to just refuse the update and continue without it.</p>\n<h2 id=\"finding-the-right-connections\">Finding the right connections</h2>\n<p>Having gotten the device recognized and seeing that it works. I moved on to the next problem. That is the fact that I have no idea how to connect a different device to be debugged. This is why I started looking for a schematic of the original JLink PLUS to see how its pins are connected only to find out that it contains an FPGA inside so it is nothing like the thing I have at the moment. </p>\n<p>The repository that contains the firmware also has a reference section where I found this <a href=\"http://akb77.com/g/stm32/jlink-ob/\">link</a>. It describes what is the meaning of each pin and how it's supposed to be connected. Trying to connect it like that didn't give any results. However, that didn't discourage me as it is for a different device, and I was looking for a f103 schematic.</p>\n<p>The other links were all from <code class=\"language-text\">blog.csdn.net</code>. I scoured the website searching for something useful in the sea of Chinese characters I don't understand and eventually stumbled upon two promising pages. The <a href=\"https://blog.csdn.net/qq_25814297/article/details/103186725\">first one</a> looked like some kind of diary that mentions how the extract the firmware from <code class=\"language-text\">JLinkARM.dll</code>, and <a href=\"https://blog.csdn.net/whik1194/article/details/90081825\">the second</a> had what I was looking for. A schematic showing which pins are used for the JTAG communication. </p>\n<p>What I was looking for was SWD pin but the schematic only gave the connections for the JTAG protocol. Having previously looked at the Versaloon source code and at pictures of other probes, I knew that the <code class=\"language-text\">SWDIO</code> and <code class=\"language-text\">SWDCLK</code> pins sometimes correspond to the <code class=\"language-text\">TCK</code> and <code class=\"language-text\">TMS</code> pins. This is how I connected my other blackpill board that was going to be the target of my debugging, and this is what I saw: </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Connecting to J-Link via USB...O.K.\nFirmware: J-Link OB-STM32F103 V1 compiled Jan  7 2019 14:10:25\nHardware version: V1.00\nS/N: -1\nVTref=3.300V\nType &quot;connect&quot; to establish a target connection, &#39;?&#39; for help\nJ-Link&gt;connect\nPlease specify device / core. &lt;Default&gt;: RP2040_M0_0\nType &#39;?&#39; for selection dialog\nDevice&gt;?\nPlease specify target interface:\n  J) JTAG (Default)\n  S) SWD\n  T) cJTAG\nTIF&gt;S\nSpecify target interface speed [kHz]. &lt;Default&gt;: 4000 kHz\nSpeed&gt;\nDevice &quot;STM32F103C8&quot; selected.\nConnecting to target via SWD\nFound SW-DP with ID 0x1BA01477\nFound SW-DP with ID 0x1BA01477\nDPv0 detected\nScanning AP map to find all available APs\nAP[1]: Stopped AP scan as end of AP map has been reached\nAP[0]: AHB-AP (IDR: 0x14770011)\nIterating through AP map to find AHB-AP to use\nAP[0]: Core found\nAP[0]: AHB-AP ROM base: 0xE00FF000\nCPUID register: 0x411FC231. Implementer code: 0x41 (ARM)\nFound Cortex-M3 r1p1, Little endian.\nFPUnit: 6 code (BP) slots and 2 literal slots\nCoreSight components:\nROMTbl[0] @ E00FF000\nROMTbl[0][0]: E000E000, CID: B105E00D, PID: 001BB000 SCS\nROMTbl[0][1]: E0001000, CID: B105E00D, PID: 001BB002 DWT\nROMTbl[0][2]: E0002000, CID: B105E00D, PID: 000BB003 FPB\nROMTbl[0][3]: E0000000, CID: B105E00D, PID: 001BB001 ITM\nROMTbl[0][4]: E0040000, CID: B105900D, PID: 001BB923 TPIU-Lite\nCortex-M3 identified.\nJ-Link&gt;</code></pre></div>\n<p>It was able to correctly identify the CPU and dump the CoreSight components. Later on, I found that the schematic is also available publicly from <a href=\"https://www.segger.com/downloads/jlink/UM08023_JLinkOBSTM32F103.pdf\">SEGGER</a>. That meant I wasted a couple of hours looking for it. </p>\n<h2 id=\"upgrading-to-the-latest-version\">Upgrading to the latest version</h2>\n<p>I didn't try debugging at this point but there was no reason It wouldn't work.\nWhat I was more interested in was getting the newest version of the firmware.\nAs found on the Chinese website the firmware for the probe doesn't come over the internet but is instead embedded in the <code class=\"language-text\">JLinkArm.dll</code> file. A quick check\nshowed that there is a corresponding <code class=\"language-text\">/opt/SEGGER/JLink/libjlinkarm.so</code> file on Linux.</p>\n<p>I used <a href=\"https://archlinux.org/packages/community/any/bless/\">bless</a> to open it and look around as it can manipulate the binary data.\nThe first thing I searched for was <code class=\"language-text\">OB-STM32F103</code>, and there it was. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e6497f5b1c82e60b8105b862e6f3b7a3/58bb7/hex-firmware.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.62162162162163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACyklEQVQ4y21TaU9TQRTtP5QPylIIjawNdEEKP8FfY0wUcIuY6BfiF1tAhEALtMBr3z5vm7e01eO9UxrU2ORmJjN955x7zp3c0uISyqUSimsVrFVrWKvUsF7l2kJ5YwuVze3R+mxbnS2uVTGzUMLTYhnVzRpK1Q1aN7FS3sTU3DxyndNTeKaJs7ZAlv6C7w8Qxz8RBENohoRux7i+C9A1JdpaiIPvXbz43ML+t0ukWQYRROhaPhrXPl6+3kPuotGA6HXx9fgG7TsPphnBtgnIDHFyYeDwvIt3Bxf4Um/jtGWqur4VOLvSYAsfPdsnkg482cernV3kmodHiGyDgAJ4XqrAhIhVeSKBDDO4TowwyODTPZ9FQR+u8CBjiX6WIk0k+Lez94YU1hsIzR503SfABIYRwSEALt4LAtD5zI1hEZlBHbhuAtN2ERNQkiQIw/ABUCl0TJhWSP6xwliBuATAeyaxLKnOxkRC0P8coQDTNIWUY4X3Hga6hl7PV8ysitvm4j0DG0aogCwrUh47DpE4LpI0oZb7FGL8R8us0NKplUD5wx8xCBcrGykctek48t5jUugKSjlFv/8P4Hm9PlKo/18hK9P1ULVvEvDofuQhK0zTDFEk//aQQ+GUOUVWNfbKIZCIUhacss8pJ/CINKSUhecj66cYDgcYDjIFuDtOmRXeaoIUSKVmBCpx2XFo3iw1j7z+aBk4aRq0Wri61allIggkmjcmnGjwMIeBxQPcw8mliS61Pk6ZSTpdTwF3NB+3tOfSKZjmTY/uDBopGvZmmzz18XH/E3Kto2MkrkVtBUhkSqPDngxptvr0/AbqOYa0SlLQ1jy06JVcawERmERqky027rQu7kwPb99/QG5heQWLxXUUas/xlGpqdh6TM3lM5udonVX1eDqP/HwB04VFTEzN4dHkLArFZRTLFSytr2J5nb5fLWPiyRR+A6ZT16R8CM3CAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hex firmware\"\n        title=\"hex firmware\"\n        src=\"/static/e6497f5b1c82e60b8105b862e6f3b7a3/fcda8/hex-firmware.png\"\n        srcset=\"/static/e6497f5b1c82e60b8105b862e6f3b7a3/12f09/hex-firmware.png 148w,\n/static/e6497f5b1c82e60b8105b862e6f3b7a3/e4a3f/hex-firmware.png 295w,\n/static/e6497f5b1c82e60b8105b862e6f3b7a3/fcda8/hex-firmware.png 590w,\n/static/e6497f5b1c82e60b8105b862e6f3b7a3/efc66/hex-firmware.png 885w,\n/static/e6497f5b1c82e60b8105b862e6f3b7a3/58bb7/hex-firmware.png 985w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This is the beginning of the firmware, the Chinese website mentioned that the\n<code class=\"language-text\">XX XX 00 20</code> should be the beginning of the firmware. That looked a little\nstrange to me but after checking against the already working binaries it all checks out.</p>\n<p>Knowing that the binary should start with the interrupt table allowed me to understand what is actually going on. This is why I knew that the first value in the <a href=\"https://microcontrollerslab.com/wp-content/uploads/2020/09/Interrupt-vector-table.png\">interrupt table</a> is the stack pointer. This being a little-endian system means that the value shown as <code class=\"language-text\">30 14 00 20</code> is interpreted as <code class=\"language-text\">0x20001430</code>. This value is the start of the stack.</p>\n<p>The main reason why the firmware always starts with <code class=\"language-text\">XX XX 00 20</code> is that the stack always resides in the internal ram of the stm32f103. Checking the <a href=\"https://stackoverflow.com/a/45767893\">memory map</a> it can be seen that the internal ram's address space is in the <code class=\"language-text\">0x20000000 - 0x40000000</code> range. </p>\n<p>If you are perceptive you might notice that this is a 512mb range and the ram on the chip is actually only 20kb so effectively the range is <code class=\"language-text\">0x20000000 - 0x20005000</code> this is why the <code class=\"language-text\">00 20</code> part never changes as it will be outside of the memory boundaries. This means that <code class=\"language-text\">XX XX 00 20</code> can safely be used as our beginning mark.</p>\n<p>The best part is that there is no need to determine the end of the firmware, as what isn't needed won't be used. Starting from the bytes that mark the beginning, we can just take 65536 (0x10000) bytes as the size of the flash is 64kb.</p>\n<p>So far so good, but this is the firmware without the bootloader, and the bootloader is kind of important. So I did the simplest thing possible and just used the bootloader from the repository that contained the firmware. </p>\n<p>I opened the downloaded <a href=\"https://github.com/GCY/JLINK-ARM-OB/blob/master/J-Link%20OB-STM32F103%20V1%20compiled%20Jan%20%207%202019/JLink-OB%20STM32F103%20JLinkARM.dll%20v6.44f%20.bin\"><code class=\"language-text\">.bin</code> file</a>, deleted the firmware contained there, by removing all of the bytes starting from <code class=\"language-text\">XX XX 00 20</code> and replacing them with the ones copied from the <code class=\"language-text\">.so</code> file. But why is a bootloader needed in the first place? What is in the bootloader and why isn't the firmware starting from <code class=\"language-text\">0x8000000</code> like it should?</p>\n<p>A custom bootloader is needed because the original firmware is supposed to be placed at <code class=\"language-text\">0x8004000</code>. Bing impossible to put it elsewhere it needs some code to move it around. The source code for the bootloader can be found\n<a href=\"http://www.crystalradio.cn/forum.php?mod=viewthread&#x26;tid=1576269\">here</a>. It is\nnothing fancy, just relocation of the interrupt table and jumping to the start\naddress.</p>\n<h2 id=\"conclusion\">Conclusion</h2>\n<p>This is how and why you can buy a cheap JLink programmer from China for less than 5$ like <a href=\"https://www.aliexpress.com/item/32743207311.html\">this</a> one. I don't believe that anybody would use this information in any malicious way but if you can, buy the real one. If you are unable to, then make one yourself don't buy the imitations. </p>\n<p>P.S. Somebody should try this on the stm32f103 imitation: gd32f103. It would\nbe the ultimate fake JLink adapter :D</p>","frontmatter":{"title":"How the JLink programmer was cloned and you can do it too.","date":"March 31, 2021","tags":["SWD","JTAG","stm32f103","JLink","blackpill"],"description":"Flash the latest JLink OB firmware to a blackpill board."}}]}},"pageContext":{"tag":"swd"}},"staticQueryHashes":["3649515864","63159454"]}